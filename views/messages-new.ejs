<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <%- include('partials/head', { title: 'Central de Mensagens', branding: settings }) %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .tab-active { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; }
        .priority-high { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen relative">
    <!-- Background Effects -->
    <div class="fixed top-0 left-0 w-96 h-96 bg-indigo-600/20 rounded-full blur-[100px] -translate-x-1/2 -translate-y-1/2 z-0"></div>
    <div class="fixed bottom-0 right-0 w-96 h-96 bg-purple-600/20 rounded-full blur-[100px] translate-x-1/2 translate-y-1/2 z-0"></div>

    <%- include('partials/navbar', { page: 'messages', user: user }) %>

    <main class="relative z-10 max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Central de Mensagens</h1>
                <p class="text-gray-400 text-sm">Gerencie respostas, tratativas e hist√≥rico de comunica√ß√µes</p>
            </div>
            
            <!-- Stats R√°pidos -->
            <div class="flex gap-3">
                <div class="bg-red-900/30 border border-red-500/30 rounded-xl px-4 py-2 text-center">
                    <p class="text-2xl font-bold text-red-400" id="stat-pending">0</p>
                    <p class="text-[10px] text-red-300 uppercase tracking-wider">Aguardando</p>
                </div>
                <div class="bg-yellow-900/30 border border-yellow-500/30 rounded-xl px-4 py-2 text-center">
                    <p class="text-2xl font-bold text-yellow-400" id="stat-in-progress">0</p>
                    <p class="text-[10px] text-yellow-300 uppercase tracking-wider">Em Tratamento</p>
                </div>
                <div class="bg-green-900/30 border border-green-500/30 rounded-xl px-4 py-2 text-center">
                    <p class="text-2xl font-bold text-green-400" id="stat-resolved">0</p>
                    <p class="text-[10px] text-green-300 uppercase tracking-wider">Resolvidos</p>
                </div>
            </div>
        </div>

        <!-- Tabs de Navega√ß√£o -->
        <div class="glass rounded-xl p-2 mb-6 flex flex-wrap gap-2 border border-gray-700/50">
            <button onclick="changeTab('all')" id="tab-all" class="tab-active px-4 py-2 rounded-lg text-sm font-semibold transition-all">
                üìä Todas as Respostas
            </button>
            <button onclick="changeTab('detractors')" id="tab-detractors" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 transition-all">
                üö® Detratores <span id="badge-detractors" class="ml-1 bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="changeTab('neutrals')" id="tab-neutrals" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 transition-all">
                ‚ö†Ô∏è Neutros
            </button>
            <button onclick="changeTab('promoters')" id="tab-promoters" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 transition-all">
                ‚≠ê Promotores
            </button>
            <button onclick="changeTab('pending-treatment')" id="tab-pending-treatment" class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 transition-all">
                ‚è≥ Pendentes de Tratativa
            </button>
        </div>

        <!-- Filtros Avan√ßados -->
        <div class="glass rounded-xl p-4 mb-6 border border-gray-700/50">
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs text-gray-400 mb-1 uppercase tracking-wider">Buscar Cliente</label>
                    <input type="text" id="filter-search" placeholder="Nome, email ou telefone..." 
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition">
                </div>
                <div class="w-40">
                    <label class="block text-xs text-gray-400 mb-1 uppercase tracking-wider">Canal</label>
                    <select id="filter-channel" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white outline-none focus:border-indigo-500 transition">
                        <option value="">Todos</option>
                        <option value="WHATSAPP">WhatsApp</option>
                        <option value="EMAIL">Email</option>
                    </select>
                </div>
                <div class="w-40">
                    <label class="block text-xs text-gray-400 mb-1 uppercase tracking-wider">Per√≠odo</label>
                    <select id="filter-period" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white outline-none focus:border-indigo-500 transition">
                        <option value="">Todo per√≠odo</option>
                        <option value="7">√öltimos 7 dias</option>
                        <option value="30">√öltimos 30 dias</option>
                        <option value="90">√öltimos 90 dias</option>
                    </select>
                </div>
                <div class="w-40">
                    <label class="block text-xs text-gray-400 mb-1 uppercase tracking-wider">Status Tratativa</label>
                    <select id="filter-treatment" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white outline-none focus:border-indigo-500 transition">
                        <option value="">Todos</option>
                        <option value="PENDING">Pendente</option>
                        <option value="IN_PROGRESS">Em Andamento</option>
                        <option value="RESOLVED">Resolvido</option>
                        <option value="DISMISSED">Descartado</option>
                    </select>
                </div>
                <button onclick="applyFilters()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-semibold text-white transition shadow-lg shadow-indigo-900/30">
                    üîç Filtrar
                </button>
                <button onclick="clearFilters()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm text-gray-400 transition">
                    ‚úï Limpar
                </button>
            </div>
        </div>

        <!-- Tabela Principal -->
        <div class="glass rounded-xl overflow-hidden shadow-xl border border-gray-700/50">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-800/80 text-gray-400 text-xs uppercase font-semibold tracking-wider">
                        <tr>
                            <th class="p-4 w-10">
                                <input type="checkbox" id="select-all" onclick="toggleSelectAll()" class="rounded bg-gray-700 border-gray-600">
                            </th>
                            <th class="p-4">Cliente</th>
                            <th class="p-4 text-center">Nota</th>
                            <th class="p-4">Coment√°rio</th>
                            <th class="p-4 text-center">Canal</th>
                            <th class="p-4">Campanha</th>
                            <th class="p-4 text-center">Tratativa</th>
                            <th class="p-4">Data</th>
                            <th class="p-4 text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="messages-list" class="divide-y divide-gray-700/50 text-sm">
                        <tr>
                            <td colspan="9" class="p-10 text-center text-gray-500">
                                <div class="flex flex-col items-center gap-2">
                                    <div class="animate-spin w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full"></div>
                                    <span>Carregando mensagens...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagina√ß√£o -->
            <div class="bg-gray-800/50 px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 border-t border-gray-700/50">
                <div class="flex items-center gap-2 text-sm text-gray-400">
                    <span>Mostrando</span>
                    <select id="page-size" onchange="loadMessages(1)" class="bg-gray-700 border-none rounded px-2 py-1 text-white text-sm">
                        <option value="10">10</option>
                        <option value="20" selected>20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>de <strong id="total-count" class="text-white">0</strong> registros</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadMessages(1)" id="btn-first" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed transition">
                        ‚èÆÔ∏è In√≠cio
                    </button>
                    <button onclick="loadMessages(currentPage - 1)" id="btn-prev" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed transition">
                        ‚óÄ Anterior
                    </button>
                    <span id="page-indicator" class="px-4 py-1.5 bg-indigo-600 rounded text-sm font-semibold">1 / 1</span>
                    <button onclick="loadMessages(currentPage + 1)" id="btn-next" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed transition">
                        Pr√≥xima ‚ñ∂
                    </button>
                    <button onclick="loadMessages(totalPages)" id="btn-last" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed transition">
                        Fim ‚è≠Ô∏è
                    </button>
                </div>
            </div>
        </div>

        <!-- A√ß√µes em Lote -->
        <div id="bulk-actions" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 glass bg-gray-900/95 rounded-xl px-6 py-4 flex items-center gap-4 shadow-2xl border border-indigo-500/30 z-50">
            <span class="text-sm text-gray-300"><strong id="selected-count" class="text-white">0</strong> selecionados</span>
            <div class="w-px h-8 bg-gray-700"></div>
            <button onclick="bulkAction('IN_PROGRESS')" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg text-sm font-semibold text-white transition">
                üìù Marcar em Tratamento
            </button>
            <button onclick="bulkAction('RESOLVED')" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-semibold text-white transition">
                ‚úÖ Marcar Resolvido
            </button>
            <button onclick="bulkAction('DISMISSED')" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm font-semibold text-white transition">
                üóëÔ∏è Descartar
            </button>
            <button onclick="clearSelection()" class="px-3 py-2 text-gray-400 hover:text-white transition">‚úï</button>
        </div>
    </main>

    <!-- Modal de Detalhes e Tratamento -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-4 z-[100]">
        <div class="glass bg-gray-900 rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl border border-gray-700">
            <!-- Header do Modal -->
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-6 py-4 flex justify-between items-center border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <div id="modal-score-badge" class="w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold">--</div>
                    <div>
                        <h3 id="modal-customer-name" class="text-lg font-bold text-white">Nome do Cliente</h3>
                        <p id="modal-customer-info" class="text-xs text-gray-400">email@example.com ‚Ä¢ (11) 99999-9999</p>
                    </div>
                </div>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-white transition text-2xl">‚úï</button>
            </div>

            <!-- Conte√∫do do Modal -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-180px)] custom-scrollbar">
                <!-- Informa√ß√µes da Resposta -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700/50">
                        <h4 class="text-xs text-gray-400 uppercase tracking-wider mb-3">üìä Detalhes da Pesquisa</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Campanha:</span>
                                <span id="modal-campaign" class="text-white font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Canal:</span>
                                <span id="modal-channel" class="text-white">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Data da Resposta:</span>
                                <span id="modal-date" class="text-white">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Problema Resolvido:</span>
                                <span id="modal-problem-solved" class="text-white">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Compraria Novamente:</span>
                                <span id="modal-would-buy" class="text-white">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700/50">
                        <h4 class="text-xs text-gray-400 uppercase tracking-wider mb-3">üë§ Dados do Cliente</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Empresa:</span>
                                <span id="modal-company" class="text-white font-medium">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Setor:</span>
                                <span id="modal-sector" class="text-white">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Regional:</span>
                                <span id="modal-regional" class="text-white">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Cargo:</span>
                                <span id="modal-role" class="text-white">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coment√°rio do Cliente -->
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 mb-6">
                    <h4 class="text-xs text-gray-400 uppercase tracking-wider mb-3">üí¨ Coment√°rio do Cliente</h4>
                    <p id="modal-comment" class="text-white italic leading-relaxed">"Sem coment√°rio registrado."</p>
                    
                    <!-- Tags de Sentimento -->
                    <div id="modal-tags" class="flex flex-wrap gap-2 mt-4">
                        <!-- Preenchido via JS -->
                    </div>
                </div>

                <!-- Hist√≥rico de Tratativas -->
                <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 mb-6">
                    <h4 class="text-xs text-gray-400 uppercase tracking-wider mb-3">üìã Hist√≥rico de Tratativas</h4>
                    <div id="modal-treatment-history" class="space-y-3">
                        <p class="text-gray-500 text-sm">Nenhuma tratativa registrada ainda.</p>
                    </div>
                </div>

                <!-- Formul√°rio de Tratativa -->
                <div class="bg-indigo-900/20 rounded-xl p-4 border border-indigo-500/30">
                    <h4 class="text-xs text-indigo-400 uppercase tracking-wider mb-3">‚úèÔ∏è Registrar Tratativa</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">Status da Tratativa</label>
                            <select id="modal-treatment-status" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white outline-none focus:border-indigo-500 transition">
                                <option value="PENDING">‚è≥ Pendente</option>
                                <option value="IN_PROGRESS">üìù Em Andamento</option>
                                <option value="RESOLVED">‚úÖ Resolvido</option>
                                <option value="DISMISSED">üóëÔ∏è Descartado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400 mb-1">A√ß√£o de Contato</label>
                            <select id="modal-contact-action" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-sm text-white outline-none focus:border-indigo-500 transition">
                                <option value="">Selecione...</option>
                                <option value="CALL">üìû Liga√ß√£o Realizada</option>
                                <option value="WHATSAPP">üí¨ WhatsApp Enviado</option>
                                <option value="EMAIL">üìß Email Enviado</option>
                                <option value="MEETING">ü§ù Reuni√£o Agendada</option>
                                <option value="VISIT">üè¢ Visita Presencial</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-400 mb-1">Observa√ß√µes da Tratativa</label>
                        <textarea id="modal-treatment-notes" rows="3" placeholder="Descreva o que foi conversado, a√ß√µes tomadas, pr√≥ximos passos..." 
                            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-sm text-white placeholder-gray-500 outline-none focus:border-indigo-500 transition resize-none"></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="saveTreatment()" class="flex-1 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-semibold text-white transition shadow-lg shadow-indigo-900/30">
                            üíæ Salvar Tratativa
                        </button>
                        <button onclick="sendRecoveryMessage()" id="btn-send-recovery" class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-semibold text-white transition shadow-lg shadow-green-900/30">
                            üì§ Enviar Msg de Recupera√ß√£o
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('nps_token');
        if (!token) window.location.href = '/login.html';

        let currentPage = 1;
        let totalPages = 1;
        let currentTab = 'all';
        let selectedItems = new Set();
        let currentResponseId = null;

        // Carrega dados iniciais
        document.addEventListener('DOMContentLoaded', () => {
            loadMessages();
            loadStats();
        });

        // Busca ao digitar (com debounce)
        let searchTimeout;
        document.getElementById('filter-search').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => applyFilters(), 500);
        });

        // Carregar estat√≠sticas
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/messages/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                document.getElementById('stat-pending').innerText = data.pending || 0;
                document.getElementById('stat-in-progress').innerText = data.inProgress || 0;
                document.getElementById('stat-resolved').innerText = data.resolved || 0;
                document.getElementById('badge-detractors').innerText = data.detractors || 0;
            } catch (e) {
                console.error('Erro ao carregar stats:', e);
            }
        }

        // Carregar mensagens
        async function loadMessages(page = 1) {
            if (page < 1) return;
            
            const limit = document.getElementById('page-size').value;
            const search = document.getElementById('filter-search').value;
            const channel = document.getElementById('filter-channel').value;
            const period = document.getElementById('filter-period').value;
            const treatment = document.getElementById('filter-treatment').value;

            let url = `/api/admin/messages?page=${page}&limit=${limit}&tab=${currentTab}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (channel) url += `&channel=${channel}`;
            if (period) url += `&period=${period}`;
            if (treatment) url += `&treatment=${treatment}`;

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                currentPage = data.currentPage;
                totalPages = data.pages;
                
                document.getElementById('page-indicator').innerText = `${currentPage} / ${totalPages}`;
                document.getElementById('total-count').innerText = data.total;
                
                // Controle dos bot√µes de pagina√ß√£o
                document.getElementById('btn-first').disabled = currentPage === 1;
                document.getElementById('btn-prev').disabled = currentPage === 1;
                document.getElementById('btn-next').disabled = currentPage >= totalPages;
                document.getElementById('btn-last').disabled = currentPage >= totalPages;

                renderMessages(data.messages);
            } catch (e) {
                console.error('Erro ao carregar mensagens:', e);
            }
        }

        // Renderizar mensagens na tabela
        function renderMessages(messages) {
            const tbody = document.getElementById('messages-list');
            
            if (!messages || messages.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="p-10 text-center text-gray-500">
                            <div class="flex flex-col items-center gap-2">
                                <svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                </svg>
                                <span>Nenhuma mensagem encontrada</span>
                                <span class="text-xs">Tente ajustar os filtros ou iniciar uma nova campanha</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = messages.map(m => {
                const isSelected = selectedItems.has(m.id);
                const scoreClass = getScoreClass(m.score);
                const treatmentClass = getTreatmentClass(m.treatmentStatus);
                const isDetractor = m.score !== null && m.score <= 6;
                const priorityClass = isDetractor && m.treatmentStatus === 'PENDING' ? 'priority-high' : '';
                
                return `
                    <tr class="hover:bg-white/5 transition ${priorityClass}" data-id="${m.id}">
                        <td class="p-4">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${m.id}')" 
                                class="rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        </td>
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm">
                                    ${(m.customer?.name || 'A')[0].toUpperCase()}
                                </div>
                                <div>
                                    <p class="font-semibold text-white">${m.customer?.name || 'Cliente An√¥nimo'}</p>
                                    <p class="text-xs text-gray-500">${m.customer?.email || m.customer?.phone || '-'}</p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl text-lg font-bold ${scoreClass}">
                                ${m.score !== null ? m.score : '-'}
                            </span>
                        </td>
                        <td class="p-4 max-w-xs">
                            <p class="text-gray-300 text-xs truncate" title="${m.comment || ''}">${m.comment ? `"${m.comment.substring(0, 80)}${m.comment.length > 80 ? '...' : ''}"` : '<span class="text-gray-500 italic">Sem coment√°rio</span>'}</p>
                        </td>
                        <td class="p-4 text-center">
                            <span class="text-lg" title="${m.channel}">${m.channel === 'WHATSAPP' ? 'üí¨' : 'üìß'}</span>
                        </td>
                        <td class="p-4">
                            <span class="text-xs text-gray-400">${m.campaign?.name || '-'}</span>
                        </td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${treatmentClass}">
                                ${formatTreatmentStatus(m.treatmentStatus)}
                            </span>
                        </td>
                        <td class="p-4">
                            <span class="text-xs text-gray-500">${m.answeredAt ? new Date(m.answeredAt).toLocaleDateString('pt-BR') : '-'}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="openDetailModal('${m.id}')" class="p-2 hover:bg-indigo-600/20 rounded-lg transition" title="Ver detalhes">
                                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Classes de estilo para scores
        function getScoreClass(score) {
            if (score === null) return 'bg-gray-700 text-gray-400';
            if (score >= 9) return 'bg-green-900/50 text-green-400 border border-green-500/30';
            if (score >= 7) return 'bg-yellow-900/50 text-yellow-400 border border-yellow-500/30';
            return 'bg-red-900/50 text-red-400 border border-red-500/30';
        }

        // Classes de estilo para status de tratativa
        function getTreatmentClass(status) {
            switch (status) {
                case 'PENDING': return 'bg-red-900/50 text-red-300 border border-red-500/30';
                case 'IN_PROGRESS': return 'bg-yellow-900/50 text-yellow-300 border border-yellow-500/30';
                case 'RESOLVED': return 'bg-green-900/50 text-green-300 border border-green-500/30';
                case 'DISMISSED': return 'bg-gray-700/50 text-gray-400 border border-gray-600/30';
                default: return 'bg-gray-700/50 text-gray-400';
            }
        }

        // Formatar status de tratativa
        function formatTreatmentStatus(status) {
            const labels = {
                'PENDING': 'Pendente',
                'IN_PROGRESS': 'Em Andamento',
                'RESOLVED': 'Resolvido',
                'DISMISSED': 'Descartado'
            };
            return labels[status] || status;
        }

        // Mudar tab
        function changeTab(tab) {
            currentTab = tab;
            currentPage = 1;
            
            // Atualiza visual das tabs
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-gray-400', 'hover:bg-gray-800');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-400', 'hover:bg-gray-800');
            
            loadMessages();
        }

        // Filtros
        function applyFilters() {
            currentPage = 1;
            loadMessages();
        }

        function clearFilters() {
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-channel').value = '';
            document.getElementById('filter-period').value = '';
            document.getElementById('filter-treatment').value = '';
            applyFilters();
        }

        // Sele√ß√£o de itens
        function toggleSelect(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            updateBulkActions();
        }

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#messages-list input[type="checkbox"]');
            const selectAll = document.getElementById('select-all').checked;
            
            checkboxes.forEach(cb => {
                const id = cb.closest('tr').dataset.id;
                if (selectAll) {
                    selectedItems.add(id);
                    cb.checked = true;
                } else {
                    selectedItems.delete(id);
                    cb.checked = false;
                }
            });
            updateBulkActions();
        }

        function clearSelection() {
            selectedItems.clear();
            document.querySelectorAll('#messages-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulk-actions');
            const count = selectedItems.size;
            
            if (count > 0) {
                bulkActions.classList.remove('hidden');
                document.getElementById('selected-count').innerText = count;
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        // A√ß√µes em lote
        async function bulkAction(status) {
            if (selectedItems.size === 0) return;
            
            const confirmed = await Swal.fire({
                title: 'Confirmar a√ß√£o',
                text: `Deseja atualizar ${selectedItems.size} registro(s) para "${formatTreatmentStatus(status)}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4F46E5',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'Sim, atualizar',
                cancelButtonText: 'Cancelar'
            });

            if (!confirmed.isConfirmed) return;

            try {
                const res = await fetch('/api/admin/treatments/bulk', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ids: Array.from(selectedItems),
                        status: status
                    })
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: 'Registros atualizados com sucesso.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    clearSelection();
                    loadMessages(currentPage);
                    loadStats();
                } else {
                    throw new Error('Erro ao atualizar');
                }
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'N√£o foi poss√≠vel atualizar os registros.'
                });
            }
        }

        // Modal de detalhes
        async function openDetailModal(id) {
            currentResponseId = id;
            
            try {
                const res = await fetch(`/api/admin/messages/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                // Preenche os dados do modal
                const scoreClass = getScoreClass(data.score);
                document.getElementById('modal-score-badge').className = `w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold ${scoreClass}`;
                document.getElementById('modal-score-badge').innerText = data.score !== null ? data.score : '-';
                
                document.getElementById('modal-customer-name').innerText = data.customer?.name || 'Cliente An√¥nimo';
                document.getElementById('modal-customer-info').innerText = `${data.customer?.email || '-'} ‚Ä¢ ${data.customer?.phone || '-'}`;
                
                document.getElementById('modal-campaign').innerText = data.campaign?.name || '-';
                document.getElementById('modal-channel').innerText = data.channel === 'WHATSAPP' ? 'üí¨ WhatsApp' : 'üìß Email';
                document.getElementById('modal-date').innerText = data.answeredAt ? new Date(data.answeredAt).toLocaleString('pt-BR') : '-';
                document.getElementById('modal-problem-solved').innerText = data.problemSolved === true ? '‚úÖ Sim' : data.problemSolved === false ? '‚ùå N√£o' : '-';
                document.getElementById('modal-would-buy').innerText = data.wouldBuyAgain === true ? '‚úÖ Sim' : data.wouldBuyAgain === false ? '‚ùå N√£o' : '-';
                
                document.getElementById('modal-company').innerText = data.customer?.companyName || '-';
                document.getElementById('modal-sector').innerText = data.customer?.sector || '-';
                document.getElementById('modal-regional').innerText = data.customer?.regional || '-';
                document.getElementById('modal-role').innerText = data.customer?.role || '-';
                
                document.getElementById('modal-comment').innerText = data.comment ? `"${data.comment}"` : '"Sem coment√°rio registrado."';
                
                // Tags de sentimento
                const tagsContainer = document.getElementById('modal-tags');
                if (data.tags && data.tags.length > 0) {
                    tagsContainer.innerHTML = data.tags.map(tag => 
                        `<span class="px-2 py-1 bg-indigo-900/50 text-indigo-300 text-xs rounded-full border border-indigo-500/30">${tag}</span>`
                    ).join('');
                } else {
                    tagsContainer.innerHTML = '';
                }

                // Status da tratativa no formul√°rio
                document.getElementById('modal-treatment-status').value = data.treatmentStatus || 'PENDING';
                document.getElementById('modal-treatment-notes').value = '';

                // Hist√≥rico de tratativas
                renderTreatmentHistory(data.treatmentHistory || []);

                // Mostrar/ocultar bot√£o de recupera√ß√£o
                const btnRecovery = document.getElementById('btn-send-recovery');
                if (data.score !== null && data.score <= 6 && data.customer?.phone) {
                    btnRecovery.classList.remove('hidden');
                } else {
                    btnRecovery.classList.add('hidden');
                }

                // Exibe o modal
                document.getElementById('detail-modal').classList.remove('hidden');
            } catch (e) {
                console.error('Erro ao carregar detalhes:', e);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'N√£o foi poss√≠vel carregar os detalhes.'
                });
            }
        }

        function renderTreatmentHistory(history) {
            const container = document.getElementById('modal-treatment-history');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma tratativa registrada ainda.</p>';
                return;
            }

            container.innerHTML = history.map(h => `
                <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-700/50">
                    <div class="flex justify-between items-start mb-2">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${getTreatmentClass(h.status)}">${formatTreatmentStatus(h.status)}</span>
                        <span class="text-[10px] text-gray-500">${new Date(h.createdAt).toLocaleString('pt-BR')}</span>
                    </div>
                    <p class="text-sm text-gray-300">${h.notes || '-'}</p>
                    <p class="text-[10px] text-gray-500 mt-1">Por: ${h.userName || 'Sistema'}</p>
                </div>
            `).join('');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            currentResponseId = null;
        }

        // Salvar tratativa
        async function saveTreatment() {
            if (!currentResponseId) return;
            
            const status = document.getElementById('modal-treatment-status').value;
            const notes = document.getElementById('modal-treatment-notes').value;
            const contactAction = document.getElementById('modal-contact-action').value;

            try {
                const res = await fetch(`/api/admin/treatments/${currentResponseId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status, notes, contactAction })
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Tratativa salva!',
                        text: 'O registro foi atualizado com sucesso.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Recarrega os dados do modal
                    openDetailModal(currentResponseId);
                    loadMessages(currentPage);
                    loadStats();
                } else {
                    throw new Error('Erro ao salvar');
                }
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'N√£o foi poss√≠vel salvar a tratativa.'
                });
            }
        }

        // Enviar mensagem de recupera√ß√£o
        async function sendRecoveryMessage() {
            if (!currentResponseId) return;
            
            const confirmed = await Swal.fire({
                title: 'Enviar mensagem de recupera√ß√£o?',
                text: 'Uma mensagem personalizada ser√° enviada ao cliente via WhatsApp.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#22C55E',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'üì§ Enviar',
                cancelButtonText: 'Cancelar'
            });

            if (!confirmed.isConfirmed) return;

            try {
                const res = await fetch(`/api/admin/treatments/${currentResponseId}/recovery`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Mensagem enviada!',
                        text: 'A mensagem de recupera√ß√£o foi enviada ao cliente.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    const data = await res.json();
                    throw new Error(data.error || 'Erro ao enviar');
                }
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: e.message || 'N√£o foi poss√≠vel enviar a mensagem.'
                });
            }
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDetailModal();
        });
    </script>
</body>
</html>
